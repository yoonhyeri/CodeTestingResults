WITH TRUCK_RENTAL_DAY  AS (
SELECT *, TIMESTAMPDIFF(DAY, START_DATE, END_DATE)+1 AS RENTAL_DATE
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY 
      JOIN CAR_RENTAL_COMPANY_CAR USING(CAR_ID)
WHERE CAR_TYPE = '트럭'), EXTRACT_DURATION_TYPE AS (
            SELECT *, CASE 
                        WHEN RENTAL_DATE >= 7 AND RENTAL_DATE < 30 THEN '7일 이상'
                        WHEN RENTAL_DATE >= 30 AND RENTAL_DATE < 90 THEN '30일 이상'
                        WHEN RENTAL_DATE >= 90 THEN '90일 이상'
                        ELSE '7일 미만' 
                      END AS  R_SECTION
            FROM TRUCK_RENTAL_DAY), ACCURACY_DISCOUNT_RATE  AS ( 
                        SELECT *, CASE 
                                    WHEN R_SECTION = '7일 미만' THEN 0
                                    WHEN R_SECTION =  DURATION_TYPE THEN DISCOUNT_RATE 
                                  END ACC_DISCOUNT_RATE
                        FROM EXTRACT_DURATION_TYPE JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN USING(CAR_TYPE)
                        )


SELECT HISTORY_ID, FLOOR(DAILY_FEE*RENTAL_DATE*(1-MAX(ACC_DISCOUNT_RATE)/100)) AS FEE
FROM ACCURACY_DISCOUNT_RATE
GROUP BY HISTORY_ID
ORDER BY FEE DESC, HISTORY_ID DESC



/*
history_id	FEE
724	6336960
681	5356240
630	4791360
558	4404960
653	3793160
722	2909040
594	1888600
680	1524750
714	1118150
591	1118150
556	813200
610	672000
676	568000
527	535000
720	532000
710	532000
701	504000
640	428000
641	426000
628	426000
623	336000
602	336000
673	321000
631	321000
654	284000
618	214000
586	214000
581	214000
546	214000
716	140000
711	107000
705	107000
627	107000
524	107000
*/